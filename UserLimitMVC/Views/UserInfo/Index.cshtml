@{

    Layout = null;

}
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>实现用户的增删改查</title>@*添加Jquery EasyUI的样式*@
    <link href="~/Content/JqueryEasyUI/jquery-easyui-1.4/themes/default/easyui.css" rel="stylesheet" />
    <link href="~/Content/JqueryEasyUI/jquery-easyui-1.4/themes/icon.css" rel="stylesheet" />
    @*添加Jquery，EasyUI和easyUI的语言包的JS文件*@
    <script src="~/Content/JqueryEasyUI/jquery-easyui-1.4/jquery.min.js"></script>
    <script src="~/Content/JqueryEasyUI/jquery-easyui-1.4/jquery.easyui.min.js"></script>
    <script src="~/Content/JqueryEasyUI/jquery-easyui-1.4/locale/easyui-lang-zh_CN.js"></script>
    @*实现对EasyUI的DataGird控件操作的JS代码*@
    <script type="text/javascript">

        $(function () {

            //当页面首次刷新的时候执行的事件

            initTable();

            //检查用户名的输入必须正确
            CheckUserName();

            //检查密码和输入密码必须相同
            checkPwdAndOKPwdIsEqualTo();

            //绑定注册按钮的事件
            bindRegisteButtonClickEvent();
        });

        //实现对DataGird控件的绑定操作

        function initTable() {

            $('#test').datagrid({   //定位到Table标签，Table标签的ID是test

                //   User是控制器，GetAllUsers是控制器中获取用户数据的一个Action

                url: '/UserInfo/GetAllUsers',   //指向后台的Action来获取当前用户的信息的Json格式的数据

                title: '用户的展示',  //标识

                //下面的这些属性如果谁不太清楚的话我建议去官方网站去学习或者在群里我们讨论，这里就不说了

                iconCls: 'icon-save',
                height: 368,
                nowrap: true,
                autoRowHeight: false,
                striped: true,
                collapsible: true,
                pagination: true,
                rownumbers: true,
                //sortName: 'ID',    //根据某个字段给easyUI排序
                sortOrder: 'asc',
                remoteSort: false,
                idField: 'ID',
                //queryParams: queryData,  //异步查询的参数

                frozenColumns: [[

                    { field: 'ck', checkbox: true },

                    { title: '主键', field: 'ID', width: 80, sortable: true },
                    { title: '登录名', field: 'UserName', width: 100, sortable: true },  //登录名
                    { title: '姓名', field: 'RealName', width: 100, sortable: true },  //用户名
                    { title: 'E-Email', field: 'Email', width: 150, sortable: true },
                    { title: '性别', field: 'Gender', width: 50, sortable: true },
                    { title: '手机', field: 'Mobile', width: 120, sortable: true },
                //{ title: 'QQ号码', field: 'QICQ', width: 100, sortable: true },
                // { title: '创建人', field: 'CreateBy', width: 90, sortable: true },
                // { title: '最后修改人', field: 'ModifiedBy', width: 90, sortable: true }
                    {title: '删除状态', field: 'DeletionState', width: 120, sortable: true }
                ]],

                toolbar: [{
                    id: 'btnadd',
                    text: '添加',
                    iconCls: 'icon-add',
                    handler: function () {
                        //实现弹出注册信息的页面
                        ShowAddUserDialog();
                    }
                }, '-', {
                    id: 'btncut',
                    text: '修改',
                    iconCls: 'icon-cut',
                    handler: function () {
                        //实现修改的方法
                        UpdateUserInfo();
                    }
                }, '-', {
                    id: 'btnIsNotCancle',
                    text: '伪删除',
                    iconCls: 'icon-remove',
                    handler: function () {
                        //实现伪删删除的方法
                        deleteBaseUserInfo("not");
                    }
                }, '-', {
                    id: 'btnCancle',
                    text: '直接删除',
                    iconCls: 'icon-remove',
                    handler: function () {
                        //实现直接删除所有数据的方法
                        deleteBaseUserInfo();
                    }
                }, '-', {
                    id: 'btnBrowse',
                    text: '浏览',
                    iconCls: 'icon-tip',
                    handler: function () {
                        //实现浏览的方法
                        UpdateUserInfo("browse");
                    }
                }, '-', {
                    id: 'btnRecycle',
                    text: '回收站',
                    iconCls: 'icon-sum',
                    handler: function () {
                        //实现回收站的方法
                        RecycleBinShow();
                    }
                }, '-', {
                    id: 'btnRestore',
                    text: '还原',
                    iconCls: 'icon-back',
                    handler: function () {
                        //实现还原的方法
                        deleteBaseUserInfo("back");
                    }
                }, '-', {
                    id: 'btnreload',
                    text: '刷新',
                    iconCls: 'icon-reload',
                    handler: function () {
                        //实现刷新栏目中的数据
                        $("#test").datagrid("reload");
                    }
                }, '-', {
                    id: 'btnSetRole',
                    text: '设置角色',
                    iconCls: 'icon-undo',
                    handler: function () {
                        //为用户设置角色
                        SetUserRole();
                    }
                }, '-', {
                    id: 'btnSetPermission',
                    text: '设置用户特殊权限',
                    iconCls: 'icon-undo',
                    handler: function () {
                        //为用户设置角色
                        SetUserRole();
                    }
                }]

            });

        }
        //easyUI 弹出添加用户的对话框
        function ShowAddUserDialog() {
            //弹出层
            $("#DivAddUser").dialog('open').dialog('setTitle', '添加用户信息');
            //在弹出层的时候删除掉文本框中的信息
            //ClearTxtInfo();
        }

        //绑定注册按钮的事件
        function bindRegisteButtonClickEvent() {
            $("#btnRegist").click(function () {
                //判断用户的信息是否通过验证
                var validate = $("#ff").form('validate');
                if (validate == false) {
                    alert("验证失败，填写信息不完整！");
                    return false;
                }
                //获取参数传递给前台
                //var postData = {
                //    UserName: $("#UserName").val(),
                //    RealName: $("#RealName").val(),
                //    UserPassword: $("#UserPassword").val(),
                //    Email: $("#Email").val(),
                //    SecurityLevel: $("#SecurityLevel").combobox('getValue'),
                //    Gender: $('input[name="Gender"]:checked').val(),
                //    Birthday: $("#Birthday").datebox('getValue'),
                //    Mobile: $("#Mobile").val(),
                //    Telephone: $("#Telephone").val(),
                //    QICQ: $("#QICQ").val(),
                //    SortCode: $("#SortCode").val(),
                //    Description: $("#Description").val()
                //};
                var postData = $("#ff").serializeArray();

                //发送异步请求到后台保存用户数据
                $.post("/UserInfo/RegisterUser", postData, function (data) {
                    if (data = "OK") {
                        //添加成功  1.关闭弹出层，2.刷新DataGird
                        alert("添加成功");
                        $("#DivAddUser").dialog("close");
                        $("#test").datagrid("reload");
                        $("#ff").form("clear");
                    }
                    else {
                        alert("添加失败，请您检查");
                    }
                });
            });
        }

        //实现直接删除数据和伪删除数据的方法
        function deleteBaseUserInfo(not) {
            //得到用户选择的数据的ID
            var rows = $("#test").datagrid("getSelections");
            //首先判断用户是否已经选择了需要删除的数据,然后循环将用户选择的数据传递到后台
            if (rows.length >= 1) {
                //遍历出用户选择的数据的信息，这就是用户用户选择删除的用户ID的信息
                var ids = "";   //1,2,3,4,5
                for (var i = 0; i < rows.length; i++) {
                    //异步将删除的ID发送到后台，后台删除之后，返回前台，前台刷新表格
                    ids += rows[i].ID + ",";
                }
                //最后去掉最后的那一个,
                ids = ids.substring(0, ids.length - 1);
                //获取用户选择的用户信息，如果用户选择了已经登录的用户的话需要给出不能删除的信息
                var userNames = "";
                for (var i = 0; i < rows.length; i++) {
                    userNames += rows[i].UserName + ",";
                }
                userNames = userNames.substring(0, userNames.length - 1);
                //首先取出来到底是直接删除还是伪删除发送异步请求的地址和是否是伪删除的参数
                var postData = "";
                if (not == null) {
                    postData = {
                        ID: ids, UserName: userNames
                    }
                }
                else {
                    postData = {
                        ID: ids, UserName: userNames, Not: not
                    }
                }
                //然后确认发送异步请求的信息到后台删除数据
                $.messager.confirm("删除信息", "您确认删除<font color='red' size='3'>" + userNames + "</font>用户吗？", function (DeleteUser) {
                    if (DeleteUser) {
                        $.get("/UserInfo/DeleteUsers", postData, function (data) {
                            if (data == "OK") {
                                //友情提示用户删除成功，刷新表格
                                $.messager.alert("友情提示", "删除/还原成功");
                                $("#test").datagrid("reload");
                                //当删除完成之后，第二次删除的时候还记得上次的信息，这样是不可以的，所以我们需要清除第一次的信息
                                //第一种方法
                                rows.length = "";
                                //第二种方法
                                $("#test").datagrid("clearSelections");
                            }
                            else {
                                $.messager.alert("友情提示", data);
                            }
                        });
                    }
                });
            }
            else {
                alert("请选择你要删除的数据");
            }
        }

        //检测注册用户登录名和修改用户名不能重复
        function CheckUserName() {
            $("#UserName").blur(function () {
                //得到验证控件的值
                var UserNameCheck = $("#UserName").val()
                //发送异步请求去验证用户名不能重复
                $.get("/UserInfo/CheckUserName", { UserName: UserNameCheck }, function (date) {
                    if (date == "OK") {
                        alert("该用户已经存在");
                        $("#UserName1").val("");
                        return;
                    }
                });
            });
            $("#UserName1").blur(function () {
                var UserNameCheck = $("#UserName1").val();
                $.get("/UserInfo/CheckUserName", { UserName: UserNameCheck }, function (date) {
                    if (date == "OK") {
                        alert("该用户已经存在");
                        $("#UserName1").val("");
                        return;
                    }
                })
            });
        }

        //验证用户两次输入的密码是否相同
        function checkPwdAndOKPwdIsEqualTo() {
            $.extend($.fn.validatebox.defaults.rules, {
                //判断必须和某个字段相同
                equalTo: {
                    validator: function (value, param) {
                        return $('#' + param[0]).val() == value;
                    },
                    message: '字段不匹配'
                }
            });
        }

    </script>
</head>
<body>
    <div>
        <!-----------------------EasyUI的DataGird控件的放置----------------------->
        <table id="test" style="width: 840px" title="用户操作" iconcls="icon-edit">
        </table>
    </div>
    <!--------------------------添加用户信息的弹出层---------------------------->
    <div id="DivAddUser" class="easyui-dialog" style="width: 580px; height: 435px; padding: 10px 20px"
        closed="true" resizable="true" modal="true" buttons="#dlg-buttons">
        <form id="ff" method="post" novalidate="novalidate">
        <fieldset>
            <legend>用户必填信息</legend>
            <table id="tblAdd">
                <tr>
                    <td>
                        <label for="UserName">
                            登录名：</label>
                    </td>
                    <td>
                        <input class="easyui-validatebox" type="text" id="UserName" name="UserName" data-options="required:true,validType:'length[1,32]'" />
                    </td>
                    <td>
                        <label for="RealName">
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;真实姓名：</label>
                    </td>
                    <td>
                        <input class="easyui-validatebox" type="text" id="RealName" name="RealName" data-options="required:true,validType:'length[1,200]'" />
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="UserPassword">
                            密码：</label>
                    </td>
                    <td>
                        <input class="easyui-validatebox" type="password" id="UserPassword" name="UserPassword"
                            data-options="required:true,validType:'length[1,200]'" />
                    </td>
                    <td>
                        <label for="OKUserPassword">
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;确认密码：</label>
                    </td>
                    <td>
                        <input class="easyui-validatebox" type="password" id="OKUserPassword" name="OKUserPassword"
                            data-options="required:true" validtype="equalTo['UserPassword']" invalidmessage="两次输入的密码不匹配" />
                    </td>
                </tr>
            </table>
        </fieldset>
        <br />
        <fieldset>
            <legend>用户选填信息</legend>
            <table id="tblAdd1">
                <tr>
                    <td>
                        <label for="Email">
                            EMail：</label>
                    </td>
                    <td>
                        <input class="easyui-validatebox" type="text" id="Email" name="Email" data-options="validType:'email'" />
                    </td>
                    <td>
                        <label for="SecurityLevel">
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;安全级别：</label>
                    </td>
                    <td>
                        <select id="SecurityLevel" class="easyui-combobox" style="width: 154px;" name="SecurityLevel"
                            data-options="required:true">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="Gender">
                            性别：</label>
                    </td>
                    <td>
                        <input class="easyui-validatebox" type="radio" name="Gender" id="Boy" value="男" checked="checked" />男&nbsp;&nbsp;
                        <input class="easyui-validatebox" type="radio" name="Gender" id="Girl" value="女" />女&nbsp;&nbsp;
                        <input class="easyui-validatebox" type="radio" name="Gender" id="No" value="未知" />未知
                    </td>
                    <td>
                        <label for="Birthday">
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;出生日期：</label>
                    </td>
                    <td>
                        <input id="Birthday" style="width: 154px;" class="easyui-datebox" required="required"
                            name="Birthday" />
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="Mobile">
                            手机号码：</label>
                    </td>
                    <td>
                        <input class="easyui-numberbox" type="text" id="Mobile" name="Mobile" />
                    </td>
                    <td>
                        <label for="Telephone">
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;电话号码：</label>
                    </td>
                    <td>
                        <input class="easyui-numberbox" type="text" id="Telephone" name="Telephone" />
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="QICQ">
                            QQ号码：</label>
                    </td>
                    <td>
                        <input class="easyui-numberbox" type="text" id="QICQ" name="QICQ" />
                    </td>
                    <td>
                        <label for="SortCode">
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;排序码：</label>
                    </td>
                    <td>
                        <input class="easyui-validatebox" type="text" id="SortCode" name="SortCode" />
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="Description">
                            备注信息：</label>
                    </td>
                    <td colspan="3">
                        <textarea style="height: 50px; width: 406px;" id="Description" name="Description"></textarea>
                    </td>
                </tr>
                <tr>
                    <td colspan="4" style="text-align: center; padding-top: 10px">
                        <a href="javascript:void(0)" class="easyui-linkbutton" id="btnRegist" iconcls="icon-ok">
                            确定</a> <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel"
                                onclick="javascript:$('#DivAddUser').dialog('close')">关闭</a>
                    </td>
                </tr>
            </table>
        </fieldset>
        </form>
    </div>
</body>
</html>
